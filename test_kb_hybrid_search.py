import asyncio
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy import text
from kb_search import search_kb
import logging
import os

# --- Настройка логирования ---
# Создаем папку logs, если ее нет
log_dir = "logs"
os.makedirs(log_dir, exist_ok=True)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler(os.path.join(log_dir, "test_kb_hybrid_search.log")),
        logging.StreamHandler(),
    ],
)
logger = logging.getLogger(__name__)

# --- Конфигурация базы данных ---
# ВНИМАНИЕ: Используйте переменные окружения для боевых систем!
DATABASE_URL = "postgresql+asyncpg://adminmaldina:maldina123!@147.78.65.141/maldinadb"
engine = create_async_engine(DATABASE_URL, echo=False)
AsyncSessionFactory = async_sessionmaker(engine, expire_on_commit=False)

# --- Тестовые данные из kb_test_samples.txt ---
TEST_SAMPLES = [
    {
        "question": "Какие кнопки управления на самой лампе цилиндр?",
        "answer": "Здравствуйте! На лампе-цилиндре расположены кнопки (слева направо): 1. Смена режима: чтение Корана / Bluetooth. Также используется для установки времени. 2. Короткое нажатие — выбор предыдущей суры. Долгое нажатие — уменьшение громкости. Также используется для установки часов. 3. Короткое нажатие — выбор следующей суры. Долгое нажатие — увеличение громкости. 4. Кнопка включения. Когда лампа включена — отвечает за паузу/воспроизведение. Подробная схема кнопок есть в карточке товара. С наилучшими пожеланиями, команда MalDina."
    },
    {
        "question": "Какой артикул у орбизов?",
        "answer": "Орбизы доступны в двух вариантах: 10 000 шт по артикулу WB: 224881518 и 96 000 шт по артикулу WB: 253793079."
    },
    {
        "question": "Что делать если игрушечный автомат не стреляет?",
        "answer": "Проверьте следующие моменты: 1. Зарядите аккумулятор 1,5 часа. 2. Вырастите орбизы до 6-8 мм в течение 4 часов (поместите орбизы в воду на 2-3 часа повторно, возможно они уменьшились). 3. Разберите и проверьте отверстия внутри - возможно орбизы застряли. Если проблема не решилась, обратитесь в службу поддержки для дальнейшей диагностики."
    },
    {
        "question": "Как правильно подобрать размер умного кольца и на какой палец его лучше носить?",
        "answer": "Размер определяется по обхвату пальца: измерьте палец лентой или ниткой, затем разделите длину на 3,14 — это будет российский размер. Носить можно на среднем, указательном или безымянном пальце — выбирайте по удобству."
    },
    {
        "question": "Сколько орбизов помещается в контейнер автомата?",
        "answer": "В магазин (задняя ручка) помещается около 300-500 штук орбизов, верхний квадратный контейнер вмещает около 400-600 штук. Для переноски орбизов рекомендуется использовать пластиковую бутылку с водой."
    },
    {
        "question": "Какие функции есть у матрасов CD8-F/HS-D7/D5?",
        "answer": "Массажные матрасы отличаются следующими характеристиками: Артикул WB: 292041982 (модель HS-D7) — основной матрас: вибрация (9 режимов работы, 9 режимов интенсивности), выбор зоны воздействия, подогрев в области поясницы. Аромаподушка с наполнителем (заменяемая), подушка под поясницу. Массажер для шеи: подогрев, роликовый массаж, смена направления, регулировка мощности и силы. Массажер для ног: подогрев, роликовый массаж, смена направления, регулировка мощности. Поверхность — велюр серого цвета. Артикул WB: 216849296 (модель CD8-F) — функции аналогичны HS-D7. Отличие только в дизайне и комплектации (пульт и инструкция на русском). Поверхность — велюр серого цвета. Артикул WB: 401482557 (модель D5) — функции такие же, как у HS-D7 и CD8-F. Поверхность — экокожа коричневого цвета. Артикул WB: 431394602 (модель D5-Dnew) — основной матрас: вибрация (9 режимов работы, 9 режимов интенсивности), выбор зоны воздействия, подогрев в пояснице. Аромаподушка с наполнителем (заменяемая), подушка под поясницу с подогревом и массажем. Массажер для шеи: подогрев, роликовый массаж, смена направления, регулировка мощности и силы. Массажер для ног: подогрев, роликовый массаж, 16 вращающихся головок, смена направления, регулировка мощности. Поверхность — экокожа."
    },
    {
        "question": "Можно ли засыпать туда пульки 6мм пластиковые?",
        "answer": "Производитель рекомендует использовать орбизы 7-8 мм. Меньшие по размеру пульки в некоторых моделях могут застревать. Рекомендуется использовать специальные орбизы, которые можно приобрести по артикулам WB: 224881518 или 253793079."
    },
    {
        "question": "Какой адаптер питания подходит к лампе?",
        "answer": "Мощность зарядного блока должна быть 2.5W."
    },
    {
        "question": "Может ли умное кольцо вибрировать при получении SMS?",
        "answer": "Нет, кольцо не вибрирует и не предназначено для получения уведомлений. Его функция — только трекинг показателей здоровья."
    },
    {
        "question": "Сколько ватт потребляет лимфомассажёр?",
        "answer": "Потребляемая мощность — 24 Вт."
    }
]


async def run_test():
    async with AsyncSessionFactory() as session:
        logger.info("--- Запуск теста гибридного поиска ---")

        for i, sample in enumerate(TEST_SAMPLES):
            query = sample["question"]
            expected_answer = sample["answer"]

            logger.info(f"\n--- Тест {i+1}/{len(TEST_SAMPLES)} ---")
            logger.info(f"Запрос: {query}")
            logger.info(f"Ожидаемый ответ (полный): {expected_answer[:100]}...") # Логируем часть ответа

            # --- Гибридный поиск ---
            logger.info("Выполнение гибридного поиска (use_hybrid_search=True)...")
            hybrid_results = await search_kb(session, query, limit=5, use_hybrid_search=True)

            found_in_hybrid = False
            for res in hybrid_results:
                # Простая проверка наличия ожидаемого ответа в результатах
                if expected_answer in res.get("answer_primary", "") or \
                   expected_answer in res.get("user_question", ""):
                    found_in_hybrid = True
                    break
            
            logger.info(f"Найдено в гибридном поиске: {found_in_hybrid}")
            if not found_in_hybrid:
                logger.warning("Ожидаемый ответ не найден в результатах гибридного поиска.")
                logger.info("Результаты гибридного поиска:")
                for res in hybrid_results:
                    logger.info(f"  ID: {res.get('id')}, Q: {res.get('user_question', '')[:50]}..., A: {res.get('answer_primary', '')[:50]}...")

            # --- Только семантический поиск (для сравнения) ---
            logger.info("Выполнение только семантического поиска (use_hybrid_search=False)...")
            semantic_results = await search_kb(session, query, limit=5, use_hybrid_search=False)

            found_in_semantic = False
            for res in semantic_results:
                if expected_answer in res.get("answer_primary", "") or \
                   expected_answer in res.get("user_question", ""):
                    found_in_semantic = True
                    break
            
            logger.info(f"Найдено в семантическом поиске: {found_in_semantic}")
            if not found_in_semantic:
                logger.warning("Ожидаемый ответ не найден в результатах только семантического поиска.")
                logger.info("Результаты только семантического поиска:")
                for res in semantic_results:
                    logger.info(f"  ID: {res.get('id')}, Q: {res.get('user_question', '')[:50]}..., A: {res.get('answer_primary', '')[:50]}...")
            
            logger.info(f"Сравнение: Гибридный нашел: {found_in_hybrid}, Семантический нашел: {found_in_semantic}")

        logger.info("--- Тест гибридного поиска завершен ---")


if __name__ == "__main__":
    asyncio.run(run_test())
